<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ .Site.Title }}</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            background-color: #fff;
            font-family: Arial, sans-serif;
        }

        .sidebar {
            width: 50vw;
            height: 95vh;
            padding: 15px;
            overflow-y: auto;
            border-left: 0px solid #ccc;
            background: #fff;
            display: flex;
            flex-direction: column;
        }

        .coordinates {
            padding: 10px;
            background: #ddd;
            font-size: 14px;
            margin-bottom: 10px;
            text-align: center;
            display: none; /* Hidden by default */
        }

        .main-container {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        img {
            max-width: 100vw;
            max-height: 100vh;
            width: auto;
            height: auto;
            object-fit: contain;
            cursor: default; /* Regular cursor by default */
        }

        .marker {
            position: absolute;
            width: 20px;
            height: 20px;
            background: red;
            color: white;
            font-size: 14px;
            font-weight: bold;
            text-align: center;
            line-height: 20px;
            border-radius: 50%;
            cursor: pointer;
            transform: translate(-50%, -50%);
        }

        .annotation {
            display: none;
            padding: 10px;
            margin-bottom: 10px;
            background: #fff;
            /*border-left: 5px solid red;*/
            font-size: 1rem;
        }

        .annotation.default {
            display: block;
        }
    </style>
</head>
<body>

    <div class="main-container">
        <img id="poster" src="/ump.webp" alt="Unix Magic Poster">

        {{ range where .Site.RegularPages "Section" "markers" }}
        <div class="marker" style="top: {{ .Params.position.top }}; left: {{ .Params.position.left }};" data-id="{{ .File.BaseFileName }}">
            {{ .Params.Number }}
        </div>
        {{ end }}
    </div>

    <div class="sidebar">
        <div class="coordinates">Cursor Position: <span id="coord-text">0%, 0%</span></div>

        <div id="default-content" class="annotation-content">
            <h3>Welcome!</h3>
            <p>Click on a marker to view the annotation.</p>
        </div>

        {{ range where .Site.RegularPages "Section" "markers" }}
        <div id="annotation-{{ .File.BaseFileName }}" class="annotation">
            <strong>{{ .Title }}:</strong> {{ .Params.description }}
            {{ .Content | safeHTML }}
        </div>
        {{ end }}
    </div>

    <script>
        const poster = document.getElementById('poster');
        const coordText = document.getElementById('coord-text');
        const coordBox = document.querySelector('.coordinates');
        let showCoordinates = false; // Track toggle state
        let naturalWidth, naturalHeight;

        // Ensure we get the full-resolution dimensions of the image
        poster.onload = function () {
            naturalWidth = poster.naturalWidth;
            naturalHeight = poster.naturalHeight;
        };

        // Function to update the annotation display
        function showAnnotation(id) {
            document.querySelectorAll('.annotation').forEach(ann => ann.style.display = 'none');
            document.getElementById("annotation-" + id).style.display = 'block';
            document.getElementById("default-content").remove();
        }

        // Toggle cursor tracking state
        function toggleCursorTracking() {
            showCoordinates = !showCoordinates;
            coordBox.style.display = showCoordinates ? 'block' : 'none';
            console.log(`Cursor tracking ${showCoordinates ? 'enabled' : 'disabled'}`);

            // Change the cursor style based on the tracking state
            poster.style.cursor = showCoordinates ? 'crosshair' : 'default';
        }

        // Show the first annotation by default
        document.addEventListener("DOMContentLoaded", function() {
          
        });

        // Event listener for markers
        document.querySelectorAll('.marker').forEach(marker => {
            marker.addEventListener('click', function () {
                showAnnotation(this.dataset.id);
            });
        });

        // Function to calculate the accurate marker position
        function getCursorPosition(event) {
            if (!showCoordinates) return; // Don't update if coordinates are hidden

            const rect = poster.getBoundingClientRect(); // Get the scaled image position
            const x = event.clientX - rect.left; // Adjust for image's position in viewport
            const y = event.clientY - rect.top;

            // Get the scaling factors based on the displayed vs. natural size
            const scaleX = naturalWidth / rect.width;
            const scaleY = naturalHeight / rect.height;

            // Convert to the correct percentage based on the full-resolution image
            const leftPercent = ((x * scaleX) / naturalWidth) * 100;
            const topPercent = ((y * scaleY) / naturalHeight) * 100;

            // Ensure markers only appear within the image bounds
            if (x < 0 || y < 0 || x > rect.width || y > rect.height) {
                coordText.textContent = "Outside image";
                return;
            }

            // Display the corrected coordinates
            coordText.textContent = `${leftPercent.toFixed(2)}%, ${topPercent.toFixed(2)}%`;

            // Log to console for easy copying
            console.log(`Marker Position -> left: ${leftPercent.toFixed(2)}%; top: ${topPercent.toFixed(2)}%;`);
        }

        // Toggle coordinate display when 'T' is pressed
        document.addEventListener('keydown', function(event) {
            if (event.key.toLowerCase() === 't') {
                toggleCursorTracking();
            }
        });

        // Attach event listener for cursor tracking
        poster.addEventListener('mousemove', getCursorPosition);
    </script>

</body>
</html>

